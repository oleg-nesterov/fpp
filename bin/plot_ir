#!/usr/bin/env python3
import matplotlib.pyplot as plt
import numpy as np
import math

def eprint(*args, **kwargs):
	print(*args, **kwargs, file = __import__('sys').stderr)

# gnuplot:
#	set colorsequence {default|classic|podo}
#	show colornames
#	show linetype
colorcycle = {
	'dflt':		['#9400d3', '#009e73', '#56b4e9', '#e69f00', '#f0e442', '#0072b2', '#e51e10', '#000000'],
	'podo':		['#000000', '#e69f00', '#56b4e9', '#009e73', '#f0e442', '#0072b2', '#d55e00', '#cc79a7'],
	'classic':	['red',     'green',   'blue',    'magenta', 'cyan',    'yellow',  'black',   'orange' ],
}
plt.rcParams['axes.prop_cycle'] = plt.cycler(color=colorcycle['dflt'])
plt.rcParams['lines.linewidth'] = 0.5

fig, axs = plt.subplots(2, 1, sharex=True, figsize=(12,6))
fig.tight_layout(pad=1)

def __bf_fill(mag, ang, min):
	nz = np.argmax(mag > min)
	if nz > 0:
		ang[0:nz] = ang[nz]
	elif mag[0] <= min:
		ang[:] = 0; return
	for n in np.flatnonzero(mag[nz+1:] <= min):
		ang[nz+n + 1] = ang[nz+n]

def bf_fill(mag, ang, min):
	mag = np.atleast_2d(mag.T)
	ang = np.atleast_2d(ang.T)
	for m, a in zip(mag, ang):
		__bf_fill(m,a, min)

def plot_ir(FILE:str, NORM:int, DT:int, NO:int, SR:int):
	DT = {4:np.single, 8:np.double, 16:np.longdouble}[DT]
	if NO > 1: DT = np.dtype((DT, NO))
	IR = np.memmap(FILE, dtype = DT, mode='r')

	fft = np.fft.rfft(IR.T).T
	if NORM:
		fft	/= (IR.shape[0] / 2)
		fft[0]	/= 2

	NB = fft.shape[0]
	assert(NB - 1 == IR.shape[0] // 2)

	mag = np.abs(fft)
	np.maximum(mag, 1e-16, out=mag)
	np.log10(mag, out=mag); mag *= 20

	ang = np.angle(fft)
	if NORM:	ang[mag < -120] = 0
	else:		bf_fill(mag,ang, -120)
	ang = np.unwrap(ang, axis=0) / np.pi

	for ax in axs: ax.clear()
	xtk = np.arange(NB) * (SR // 2 / (NB - 1))
	axs[0].plot(xtk, mag)
	axs[1].plot(xtk, ang)

	axs[0].set_ylim(-60, 20)
	lo, hi = ang.min(), ang.max()
	if hi - lo >= 1/2:
		LO, HI = math.floor(2*lo)/2, math.ceil(2*hi)/2
		pad = (HI - LO) / 50
		if HI - hi < pad: HI += pad
		if lo - LO < pad: LO -= pad
		axs[1].set_ylim(LO, HI)

	for ax in axs:
		ax.margins(1/100, 1/50)
		ax.grid(True, linestyle=(0,(1,3)), color='grey', linewidth=0.5)
		lgd = ax.legend(range(0, NO), loc='upper right')
		lgd.set_visible(False)
		for chn, lgl in enumerate(lgd.get_lines()):
			lgl.__chn = chn

#------------------------------------------------------------------------------
zorder = 100
def toggle_obj(obj):
	global zorder
	on = not obj.get_visible()
	if on:
		zorder += 1
		obj.set_zorder(zorder)
	obj.set_visible(on)
	fig.canvas.draw_idle()
	return on

def toggle_chn(chn):
	for ax in axs:
		if chn >= len(ax.get_lines()):
			continue
		on = toggle_obj(ax.get_lines()[chn])
		ax.get_legend().get_lines()[chn].set_alpha(1.0 if on else 0.2)

def ax_move(ax, dx, dy, _abs):
	if dx != 0:
		lo, hi = ax.get_xlim()
		if not _abs: dx *= (hi - lo)
		ax.set_xlim(lo - dx, hi - dx)
	if dy != 0:
		lo, hi = ax.get_ylim()
		if not _abs: dy *= (hi - lo)
		ax.set_ylim(lo - dy, hi - dy)
	fig.canvas.draw_idle()

def ax_zoom(ax, kx, ky, at=None):
	if at is None:
		at = (sum(ax.get_xlim()) / 2,
		      sum(ax.get_ylim()) / 2)
	if kx != 1:
		(lo, hi), ct = ax.get_xlim(), at[0]
		ax.set_xlim(ct + (lo - ct) / kx, ct + (hi - ct) / kx)
	if ky != 1:
		(lo, hi), ct = ax.get_ylim(), at[1]
		ax.set_ylim(ct + (lo - ct) / ky, ct + (hi - ct) / ky)
	fig.canvas.draw_idle()

def on_pick(event):
	toggle_chn(event.artist.__chn)

def on_key(event):
	if event.key == '!':
		from tkinter.simpledialog import askstring
		code = askstring('eval', '')
		try:
			if code: exec(code, globals())
		except Exception as e:
			eprint("ERR!! exec:", e)
	elif event.key == 'x':
		for ax in axs:
			on = toggle_obj(ax.get_legend())
			for lgl in ax.get_legend().get_lines():
				lgl.set_picker(5 if on else False)
	elif event.key == 't':
		for chn in range(0, 10):
			toggle_chn(chn)
	elif event.key.isdigit():
		toggle_chn(int(event.key))

fig.canvas.mpl_connect('pick_event', on_pick)
fig.canvas.mpl_connect('key_press_event', on_key)

#------------------------------------------------------------------------------
import array, termios, fcntl, os

rdy = array.array('I', [0])
def check_input():
	fcntl.ioctl(0, termios.FIONREAD, rdy)
	if rdy[0]:
		line = os.read(0, 1024).decode('ascii')
		file, norm, dt,no,sr, ack = line.split()
		plot_ir(file, int(norm), int(dt), int(no), int(sr))
		fig.canvas.draw_idle()
		with open(ack, 'bw', buffering=0) as f:
			f.write(b"ACK\n")

fig.canvas.new_timer(interval=100, callbacks=[(check_input, [], {})]).start()
plt.show()
